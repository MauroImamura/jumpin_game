<!doctype HTML>
<html>
    <head>
        <meta charset="UTF-8"/>
        <title>Jumpin Game</title>
        <style>
            body {
                background-color: rgb(0, 0, 0);
            }
            canvas {
                position: absolute;
                top: 0px;
                bottom: 0px;
                left: 0px;
                right: 0px;
                margin: auto;
            }
        </style>
    </head>
    <body>
        <script>
            
            var canvas, context, game_height=500, game_width, frames=0, jump_limit=3, gravity=1.5, record, current_state,
            
            is = {
                ready: 0,
                playing: 10,
                lost: 20
            }, 
            
            ground = {
                y: game_height-50,
                height: 50,
                color: "#363636",

                draws: function() {
                    context.fillStyle = this.color;
                    context.fillRect(0,this.y,game_width,this.height);
                }
            },
            
            player = {
                x: 50,
                y: 0,
                width: 25,
                height: 25,
                color: "#FFF",
                fall_speed: 0,
                fall_acceleration: gravity,
                jump_speed: 20,
                jump_count: 0,
                score: 0,
                damageable: true,

                updates: function() {
                    this.y += this.fall_speed;
                    this.fall_speed += this.fall_acceleration;

                    if (this.y > ground.y - this.height && current_state != is.lost) {
                        this.y = ground.y - this.height;
                        this.fall_speed = 0;
                        this.jump_count = 0;
                    }
                    else if (current_state == is.lost && this.y >= 5*game_height) {
                        this.fall_speed = 0;
                        this.fall_acceleration = 0;
                    }
                },

                jumps: function() {
                    if (this.jump_count < jump_limit) {
                        this.fall_speed = -this.jump_speed;
                        this.jump_count ++;
                    }
                },

                reset: function() {
                    this.fall_acceleration = gravity;
                    player.y = 0;
                    player.fall_speed = 0;
                    if (this.score > record) {
                        localStorage.setItem("record", this.score);
                        record = this.score
                    };

                    this.score = 0;
                    shield.current = shield.default;
                },

                draws: function() {
                    context.fillStyle = this.color;
                    context.fillRect(this.x,this.y,this.width, this.height);
                },
            },

            obstacles = {
                list: [],
                colors: ["#888888","#8888CC","#88CC88","#CC8888"],
                insert_time: 0,

                insert: function() {
                    this.list.push({
                        x: game_width,
                        //x: 200, -> debug
                        speed: 5 + Math.floor(Math.random()*2),
                        width: 30,
                        height: Math.floor(50*(1+2*Math.random())),
                        color: this.colors[Math.floor(4*Math.random())],
                        scored: false,
                    });

                    this.insert_time = 50;
                },

                updates: function() {
                    if (this.insert_time == 0) {
                        this.insert();
                    }else{
                        this.insert_time --;
                    };

                    for (var i = 0, total = this.list.length; i < total; i++){
                        this.list[i].x -= this.list[i].speed;

                        if (player.damageable && player.x < this.list[i].x + this.list[i].width && player.x + player.width > this.list[i].x && player.y + player.height > ground.y - this.list[i].height) {
                            
                            player.damageable = false;
                            setTimeout(function(){player.damageable = true;},500)
                            
                            if (shield.current == 0) {
                                current_state = is.lost
                            }
                            else {
                                shield.current --;
                            }
                        }
                        else if (this.list[i].x + this.list[i].width < player.x && this.list[i].scored == false) {
                            player.score ++;
                            this.list[i].scored = true;
                        }
                        else if (this.list[i].x <= -this.list[i].width){
                            this.list.splice(i,1)
                            total --;
                            i --;
                        }
                    }
                },

                draws: function(){
                    for (var i = 0, total = this.list.length; i < total; i++){
                        context.fillStyle = this.list[i].color;
                        context.fillRect(this.list[i].x, ground.y-this.list[i].height,this.list[i].width,this.list[i].height);
                    }
                }
            },

            bonus = {
                max_height: 0.50*game_height,
                min_height: 0.15*game_height,
                list: [],
                colors: ["#00FF00","#FFFF00"],
                insert_time: 350,

                insert: function() {
                    this.list.push({
                        x: game_width,
                        y: this.min_height + (this.max_height-this.min_height)*Math.random(),
                        size: 30,
                        speed: 5,
                        effect: Math.floor(10*Math.random()),
                    })

                    this.insert_time = 350
                },

                updates: function() {
                    if (this.insert_time == 0) {
                        this.insert();
                    }
                    else{
                        this.insert_time --;
                    }

                    for (var i=0, total = this.list.length; i < total; i++){

                        this.list[i].x -= this.list[i].speed;

                        if (player.x < this.list[i].x + this.list[i].size && player.x + player.width > this.list[i].x && player.y + player.height > this.list[i].y && player.y < this.list[i].y+this.list[i].size) {
                            
                            if (this.list[i].effect <= 7) {
                                player.score += 5;
                            }
                            else {
                                if (shield.current < shield.default){
                                    shield.current ++;
                                }
                                else {
                                    player.score += 10;
                                }
                            }
                            this.list.splice(i,1);
                            total --;
                            i--;
                        }

                    }
                },

                draws: function() {
                    for (var i=0, total=this.list.length; i<total; i++){
                        if (this.list[i].effect <= 7) {
                            context.fillStyle = this.colors[1];
                        }
                        else{
                            context.fillStyle = this.colors[0];
                        }
                        context.fillRect(this.list[i].x, this.list[i].y, this.list[i].size,this.list[i].size);
                    }
                }
            },

            shield = {
                default: 3,
                current: 3,
                width: 15,
                height: 25,
                x: player.x,
                gap: 25,
                y: game_height - 35,
                color: "#00FF00",
			
                draws: function(){
                    context.fillStyle = "#FFF";
                    context.font = "30px Arial";
                    context.fillText("Shield:",this.x,this.y+this.height-2);
                        context.fillStyle = this.color;
                        for(var i=0; i<this.current; i++){
                            context.fillRect(3*this.x + this.gap*i, this.y,this.width,this.height);
                        }
                }
		    };
            
            function main() {
                game_width = window.innerWidth;
                canvas = document.createElement("canvas");
                canvas.width = game_width;
                canvas.height = game_height;
                canvas.style.border = "2px solid #FFFFFF";

                context = canvas.getContext("2d");
                document.body.appendChild(canvas);
                document.addEventListener("mousedown", clicked);

                current_state = is.ready;

                if (!localStorage.getItem("record")) {
                    record = 0
                }
                else {
                    record = localStorage.getItem("record");
                }
                run()
            }

            function clicked(event) {
                //alert("Clicked!") -> debug
                if (event.clientY <= canvas.getBoundingClientRect(DOMRect).bottom && event.clientY >= canvas.getBoundingClientRect(DOMRect).top) {
                    if (current_state == is.playing) {
                        player.jumps();
                    }
                    else if (current_state == is.ready) {
                        current_state = is.playing;
                    }
                    else if (current_state == is.lost && player.y >= 3*game_height) {
                        current_state = is.ready;
                        obstacles.list = [];
                        player.reset();
                    }
                }
            }

            function run() {
                updates();
                draws();

                window.requestAnimationFrame(run);
            }

            function updates() {
                frames++;

                player.updates();

                if (current_state == is.playing) {
                    obstacles.updates();
                    bonus.updates();
                }
            }

            function draws() {
                context.fillStyle = "#191970";
                context.fillRect(0,0,game_width,game_height);
                context.fillStyle = "#FFF";
                context.font = "30px Arial";
                context.fillText("Score:",player.x,30);
                context.fillText(player.score,3*player.x,30);

                if (current_state == is.ready) {
                    context.fillStyle = "#00AA00";
                    context.fillRect(0, game_height/2 - 100, game_width, 100);
                    context.save();
                    context.translate(game_width/2, game_height/2 - 50);
                    context.fillStyle = "#FFF";
                    context.fillText("JUMPIN GAME", -90, -10);
                    context.fillText("Clique para começar!", -130, 30);
                    context.restore();
                }
                else if (current_state == is.lost) {
                    context.fillStyle = "#AA0000";
                    context.fillRect(0, game_height/2 - 100, game_width, 100);
                    context.save();
                    context.translate(game_width/2, game_height/2 - 50);
                    context.fillStyle = "#FFF";

                    if (player.score > record) {
                        context.fillText("Você bateu o record!", -110, -10);
                        context.fillText("Record atual:", -90, 30);
                        context.fillText(player.score, 120, 30);
                    } 
                    else {
                        context.fillText("Você foi abatido.", -70, -10);
                        context.fillText("Record atual:", -90, 30);
                        context.fillText(record, 120, 30);
                    }

                    context.restore();

                }
                else{
                    obstacles.draws();
                    bonus.draws();
                };

                ground.draws();
                shield.draws()
                player.draws();
            }

            main()
        </script>
    </body>
</html>